#!/usr/bin/env sh

# Enable loading of secret files via `chezmoi secret`.
export CHEZMOI_SECRETS=1

# Determine the base token directory
TOKEN_BASE_DIR={{ if .work -}} "work/tokens" {{- else if .personal -}} "personal/tokens" {{- else -}} "tokens" {{- end }}

# Helper to export a key and announce it.
export_key() {
    var_name=$1
    secret_path=$2
    if secret_value=$(pass show "$secret_path" 2>/dev/null); then
        export "$var_name=$secret_value"
        echo "env+ $var_name"
    fi
}

load_secret() {
    key=$1
    case "$key" in
    openai) export_key OPENAI_API_KEY "$TOKEN_BASE_DIR/openai/codex" ;;
    ollama) export_key OLLAMA_API_KEY "$TOKEN_BASE_DIR/ollama/ollama" ;;
    gemini) export_key GEMINI_API_KEY "$TOKEN_BASE_DIR/gemini/gemini-cli" ;;
    openrouter) export_key OPENROUTER_API_KEY "$TOKEN_BASE_DIR/openrouter" ;;
    anthropic) export_key ANTHROPIC_API_KEY "$TOKEN_BASE_DIR/anthropic" ;;
    github) export_key GITHUB_TOKEN "$TOKEN_BASE_DIR/github/gh-cli" ;;
    quay) export_key QUAY_ENCRYPTED_PASSWORD "$TOKEN_BASE_DIR/quay/podman" ;;
    context) export_key CONTEXT7_API_KEY "$TOKEN_BASE_DIR/context7/mcp" ;;
    figma) export_key FIGMA_API_KEY "$TOKEN_BASE_DIR/figma/mcp" ;;
    xai) export_key GROK_API_KEY "$TOKEN_BASE_DIR/xai/cli" ;;
    *) echo "Unknown API key: $key" ;;
    esac
}

if [ "$#" -gt 0 ]; then
    for key in "$@"; do
        load_secret "$key"
    done
else
    load_secret ollama
    load_secret openai
    load_secret gemini
    load_secret openrouter
    load_secret anthropic
    load_secret github
    load_secret quay
    load_secret context
    load_secret figma
    load_secret xai
fi
