# UNIX common
$env:EDITOR = "nvim"
$env:PAGER = "less -R"

$env:NVIM_APPNAME="nvim-lazy"

# Startship
$env:STARSHIP_CONFIG = "$HOME\.config\starship\starship.toml"

# Perforce
$env:P4ENVIRO = "$HOME\.config\p4\p4enviro"
$env:P4ALIASES = "$HOME\.config\p4\p4aliases"
$env:P4TICKETS = "$HOME\.p4tickets"

# yazi
$env:YAZI_CONFIG_HOME = "$HOME\.config\yazi"
if (Test-Path "$env:PROGRAMFILES\Git\usr\bin\file.exe") {
    $env:YAZI_FILE_ONE = "$env:PROGRAMFILES\Git\usr\bin\file.exe"
} elseif (Test-Path "$env:LOCALAPPDATA\Programs\Git\usr\bin\file.exe") {
    $env:YAZI_FILE_ONE = "$env:LOCALAPPDATA\Programs\Git\usr\bin\file.exe"
}

# tealdeer
$env:TEALDEER_CONFIG_DIR = "$HOME\.config\tealdeer"

$env:FZF_DEFAULT_OPTS = @"
--height=50%
--multi
--layout=reverse
--info=inline
"@

$env:PATH += ";"

# SDKs & package managers
if (Test-Path "$HOME\.cargo") {
    $env:CARGO_HOME = "$HOME\.cargo"
    $env:Path += "$env:CARGO_HOME\bin;"
}

if (Test-Path "$HOME\vcpkg") {
    $env:VCPKG_ROOT = "$HOME\vcpkg"
    $env:Path += "$env:VCPKG_ROOT;"
}

if (Test-Path "$HOME\scoop") {
    $env:SCOOP_HOME = "$HOME\scoop"
    $env:Path += "$env:SCOOP_HOME\shims;"
}

if (Test-Path "$env:APPDATA\nvm") {
    $env:NVM_HOME = "$env:APPDATA\nvm"
    $env:Path += "$env:NVM_HOME;"
}

if (Test-Path "$env:PROGRAMFILES\Java\jdk-22") {
    $env:JAVA_HOME = "$env:PROGRAMFILES\Java\jdk-22"
    $env:Path += "$env:JAVA_HOME\bin;"
}

if (Test-Path "$env:PROGRAMFILES\Android\Android Studio") {
    $env:Path += "$env:PROGRAMFILES\Android\Android Studio\bin;"
}

if (Test-Path "$env:LOCALAPPDATA\Android\Sdk") {
    $env:ANDROID_HOME = "$env:LOCALAPPDATA\Android\Sdk"
    $env:Path += "$env:ANDROID_HOME\cmdline-tools\latest\bin;"
    $env:Path += "$env:ANDROID_HOME\platform-tools;"
    $env:Path += "$env:ANDROID_HOME\emulator;"
}

if (Test-Path "C:\Gradle\gradle-8.10") {
    $env:GRADLE_HOME = "C:\Gradle\gradle-8.10"
    $env:Path += "$env:GRADLE_HOME\bin;"
}

if (Test-Path "C:\Maven\apache-maven-3.9.9") {
    $env:MAVEN_HOME = "C:\Maven\apache-maven-3.9.9"
    $env:Path += "$env:MAVEN_HOME\bin;"
}

$env:Path += "$HOME\Documents\PowerShell\Scripts;"

{{ if .work -}}
$proxy_ip   = {{ .proxyIP | quote }}
$proxy_port = {{ .proxyPort | quote }}
$serial     = {{ .androidSerial | quote }}

# ── Run once per Windows startup ────────────────────────────────
$firstBootMarker = "$env:TEMP\first_boot_adb_done"

if (-not (Test-Path $firstBootMarker)) {
    if (Get-Command adb -ErrorAction SilentlyContinue) {
        Write-Host "Setting up ADB $serial..." -ForegroundColor Green
        adb -s $serial forward tcp:$proxy_port tcp:$proxy_port
        adb forward --list
        New-Item -ItemType File -Path $firstBootMarker -Force | Out-Null
    }
}

# ── Auto-detect proxy ───────────────────────────────────────────
if (Test-NetConnection -ComputerName $proxy_ip -Port $proxy_port -InformationLevel Quiet) {
    $env:ALL_PROXY   = "http://${proxy_ip}:${proxy_port}"
    $env:HTTP_PROXY  = $env:ALL_PROXY
    $env:HTTPS_PROXY = $env:ALL_PROXY
    Write-Host "Using HTTP proxy $env:ALL_PROXY" -ForegroundColor Green
} else {
    Remove-Item Env:\ALL_PROXY, Env:\HTTP_PROXY, Env:\HTTPS_PROXY -ErrorAction SilentlyContinue
}

$env:NO_PROXY += {{ .workNoProxy | quote }}
{{ end -}}
