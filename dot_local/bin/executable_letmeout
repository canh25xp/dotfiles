#!/usr/bin/env bash

# Total workday duration in minutes: 8.8 hours work + 1 hour lunch
TOTAL_MINUTES=588
STATE_ROOT="${XDG_RUNTIME_DIR:-/tmp}"
STATE_FILE="$STATE_ROOT/letmeout_message_shown"

raw=""
if command -v pwsh.exe >/dev/null 2>&1; then
    raw=$(pwsh.exe -NoProfile -Command '[Math]::Floor(((Get-Date) - (gcim Win32_OperatingSystem).LastBootUpTime).TotalMinutes)' 2>/dev/null | tr -d '\r')
fi

if [[ -z "$raw" ]]; then
    raw=$(awk '{printf "%d\n", ($1/60)}' /proc/uptime 2>/dev/null)
fi

if [[ -z "$raw" || ! "$raw" =~ ^[0-9]+$ ]]; then
    raw=0
fi

difference=$(( raw - TOTAL_MINUTES ))
if (( difference >= 0 )); then
    sign="+"
    span=$difference
else
    sign="-"
    span=$(( -difference ))
fi

hours=$(( span / 60 ))
minutes=$(( span % 60 ))

echo "${sign} ${hours}h ${minutes}m"

if (( difference >= 0 )); then
    if [[ -f "$STATE_FILE" ]]; then
        exit 0
    fi

    # Remember that the popup has been displayed so we only show it once per cycle.
    : >"$STATE_FILE"

    if command -v tmux >/dev/null 2>&1; then
        tmux_version=$(tmux -V 2>/dev/null | awk '{print $2}')
        if [[ -n "$tmux_version" ]]; then
            # tmux display-popup is available from tmux 3.2 onward. Earlier versions fall back quietly.
            if tmux display-popup -w40% -h25% -E "printf 'Congrats! You made it out alive.\nKeep up good work.\n'; read -n 1 -s -r -p '[press enter to continue]'" 2>/dev/null; then
                exit 0
            fi
        fi
    fi
else
    rm -f "$STATE_FILE" 2>/dev/null
fi
