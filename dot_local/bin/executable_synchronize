#!/usr/bin/env bash

set -euo pipefail

readonly SCRIPT_NAME="synchronize"
dry_run=false

readonly REPOS=(
  "chezmoi::$HOME/.local/share/chezmoi"
  "nvim-lazy::$HOME/.config/nvim-lazy"
  "password-store::$HOME/.password-store"
  "DevNote::$HOME/Documents/DevNote"
  "BunniesDiary::$HOME/Documents/BunniesDiary"
)

log() {
  printf '[%s] %s\n' "$SCRIPT_NAME" "$*"
}

fail() {
  printf '[%s] %s\n' "$SCRIPT_NAME" "$*" >&2
  exit 1
}

ensure_repo_clean() {
  local name="$1"
  local path="$2"

  if [[ ! -d "$path" ]]; then
    fail "$name path \"$path\" does not exist"
  fi

  if ! git -C "$path" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    fail "$name at \"$path\" is not a git repository"
  fi

  local status
  status="$(git -C "$path" status --porcelain)"
  if [[ -n "$status" ]]; then
    fail "$name at \"$path\" has uncommitted changes; aborting"
  fi
}

sync_repo() {
  local name="$1"
  local path="$2"

  log "Synchronizing $name ($path)"
  if $dry_run; then
    git -C "$path" pull --ff-only --dry-run
    git -C "$path" push --dry-run
    return
  fi

  git -C "$path" pull --ff-only
  git -C "$path" push
}

main() {
  local entry

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -n|--dry-run)
        dry_run=true
        ;;
      -*)
        fail "Unknown option: $1"
        ;;
      *)
        fail "Unexpected argument: $1"
        ;;
    esac
    shift
  done

  for entry in "${REPOS[@]}"; do
    local name="${entry%%::*}"
    local path="${entry#*::}"
    ensure_repo_clean "$name" "$path"
  done

  for entry in "${REPOS[@]}"; do
    local name="${entry%%::*}"
    local path="${entry#*::}"
    sync_repo "$name" "$path"
  done

  log "Synchronization complete"
}

main "$@"
